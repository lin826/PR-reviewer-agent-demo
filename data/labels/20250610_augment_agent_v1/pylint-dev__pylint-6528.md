Agent patch is far less clean
- defining a local function when could be using common abstraction of `_is_ignored_file` 
- not using `skip_subtrees`